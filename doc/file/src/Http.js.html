<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/Http.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/thegroundwork/groundwork.js.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Auth.js~Auth.html">Auth</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Dictionary.js~Dictionary.html">Dictionary</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Donation.js~Donation.html">Donation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Event.js~Event.html">Event</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/EventCategory.js~EventCategory.html">EventCategory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/EventInvitation.js~EventInvitation.html">EventInvitation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/EventMessage.js~EventMessage.html">EventMessage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/EventTicket.js~EventTicket.html">EventTicket</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Groundwork.js~Groundwork.html">Groundwork</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Http.js~Http.html">Http</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Payment.js~Payment.html">Payment</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Profile.js~Profile.html">Profile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Quickcard.js~Quickcard.html">Quickcard</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/SchemaUtils.js~SchemaUtils.html">SchemaUtils</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Subscription.js~Subscription.html">Subscription</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Supporter.js~Supporter.html">Supporter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-deprecate">deprecate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-epoch">epoch</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-has">has</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isApiVersion">isApiVersion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isEmpty">isEmpty</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-max">max</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mixin">mixin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-normalizeUrl">normalizeUrl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-only">only</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-urlJoin">urlJoin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-validEmail">validEmail</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ENDPOINT_CATEGORY">ENDPOINT_CATEGORY</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ENDPOINT_EVENT">ENDPOINT_EVENT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ENDPOINT_HOST_UNSUBSCRIBE">ENDPOINT_HOST_UNSUBSCRIBE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ENDPOINT_INVITATION">ENDPOINT_INVITATION</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ENDPOINT_MESSAGE">ENDPOINT_MESSAGE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ENDPOINT_TICKET">ENDPOINT_TICKET</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-NAMESPACE">NAMESPACE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-API_URL">API_URL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-API_VERSION">API_VERSION</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AUTH_ACCESS_TOKEN">AUTH_ACCESS_TOKEN</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AUTH_GWID">AUTH_GWID</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AUTH_TOKEN_TYPE">AUTH_TOKEN_TYPE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CONFIG_AUTH">CONFIG_AUTH</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DEFAULT_API_URL">DEFAULT_API_URL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-FACEBOOK_APP_ID">FACEBOOK_APP_ID</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-OAUTH_CLIENT_ID">OAUTH_CLIENT_ID</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RE_API_VERSION">RE_API_VERSION</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/Http.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/*global TAG, __LOG__, btoa*/

import * as constants from &apos;./constants&apos;;
import Dictionary from &apos;./Dictionary&apos;;
import axios from &apos;axios&apos;;
import merge from &apos;lodash-es/merge&apos;;
import { urlJoin, isEmpty } from &apos;./utils&apos;;

/** @type {String} */
const API_VERSION_HEADER = &apos;gw-api-version&apos;;

/** @type {String} */
const CLIENT_HEADER = &apos;gw-js-client&apos;;

/** @type {Function} */
const CLIENT_VERSION = (TAG) ? TAG.replace(/[\s]*/g, &apos;&apos;) : &apos;None&apos;;

// Template for XHR responses
/** @type {Object} */
const GENERIC_RESPONSE = Object.freeze({
  config: {},
  data: {},
  headers: {},
  status: 0,
  statusText: &apos;&apos;
});

/**
 * Core AJAX handling with the API
 *
 * @desc
 * Under the hood XHR is handled via Axios - https://github.com/mzabriskie/axios
 * which provides a simple Promise-based interface for JSON communication via
 * XHR.
 *
 * Http also manages custom headers needed by The Groundwork API. `gw-version`
 * is added to all requests. If the client has received an auth token, the
 * appropriate `Authorization` header will be sent as well.
 *
 * All HTTP verb methods (get, put, post, delete) return a Promise for handling
 * success and error states.
 *
 * @example
 * let http = new Http();
 * // make a GET request to `/foo`
 * http.get(&apos;foo&apos;).then((response) =&gt; {
 *    console.log(response)
 *  ).catch((err) =&gt; {
 *    console.log(error);
 * });
 *
 */
export default class Http {
  /**
   * Constructor
   * @param {Dictionary} config - client configuration
   */
  constructor(config) {
    /** @type {Dictionary} */
    this.config = (config &amp;&amp; config instanceof Dictionary) ?
      config : new Dictionary();

    /** @type {Object} */
    this.genericResponse = GENERIC_RESPONSE;

    this.setupRequestInterceptors();
  }

  /**
   * Create a mock Axios response, used in error messages returned from
   * Promises that don&apos;t make it to the server (validation errors, etc.)
   *
   * @param {Object} [mock] - object to merge into genericResponse
   * @return {Object}
   */
  generateMockResponse(mock = {}) {
    return merge({}, this.genericResponse, mock);
  }

  /**
   * Generate a 400 response. This is usually used to throw an error in a
   * consistent format without hitting the API, such a schema validation error
   *
   * @param {Object} error - error object to return
   * @param {Number} [code] - http code for error
   * @param {String} [status] - error status message
   * @return {Object}
   */
  generateErrorResponse(error = {}, code = 400, status = &apos;Invalid Data&apos;) {
    return this.generateMockResponse({
      status: code,
      statusText: status,
      data: {
        error
      }
    });
  }

  /**
   * Return a standardizes object to use in validation error messages
   *
   * @return {Object}
   */
  generateErrorObject() {
    return {
      valid: false,
      fields: [],
      msg: []
    };
  }

  /**
   * Predicate: checks presence of AUTH_ACCESS_TOKEN
   *
   * @return {Boolean}
   */
  hasAuthToken() {
    const auth = this.config.get(constants.CONFIG_AUTH);
    if (!auth) { return false; }
    return !!auth[constants.AUTH_ACCESS_TOKEN];
  }

  /**
   * Create a string auth token for use in Authorization headers
   *
   * @return {String|undefined}
   */
  generateAuthorizationHeader() {
    const a = this.config.get(constants.CONFIG_AUTH);
    if (isEmpty(a)) {
      if (__LOG__) {
        console.warn(&apos;No authorization token is set!&apos;); // eslint-disable-line
      }
      return undefined;
    }
    return `${ a[constants.AUTH_TOKEN_TYPE] }\ ${ a[constants.AUTH_ACCESS_TOKEN] }`;
  }

  /**
   * Generate a basic auth token for use in Authorization headers
   *
   * @return {String|undefined}
   */
  generateBasicAuthHeader() {
    const id = this.config.get(constants.OAUTH_CLIENT_ID);
    if (!id) {
      if (__LOG__) {
        console.warn(&apos;No oauth_client_id is set!&apos;); // eslint-disable-line
      }
      return undefined;
    }
    return `Basic ${ btoa(id + &apos;:&apos;) }`; // eslint-disable-line
  }

  /**
   * Generate an object of default headers
   *
   * Note: the `Authorization` header can be omit from a request by passing
   * a `noauth` property in the requestConfig object.
   *
   * @example
   * let http = new Http(new Dictionary({auth: authObject}));
   * http.get(&apos;foo&apos;, { noauth: true }); // will not send Authorization header
   *
   * @param {Object} [requestConfig] - request config object
   * @return {Object}
   */
  defaultHeaders(requestConfig = {}) {
    const apiVersion = this.config.get(constants.API_VERSION);
    const headers = {
      [CLIENT_HEADER]: `js-${ CLIENT_VERSION }`
    };

    // Attach an API Version header
    if (apiVersion) {
      headers[API_VERSION_HEADER] = apiVersion;
    }

    // Add Authorization header if config.noauth is falsy &amp; auth is truthy
    if (!requestConfig.noauth &amp;&amp; this.hasAuthToken()) {
      headers.Authorization = this.generateAuthorizationHeader();
    }

    // Add Basic Auth header if config.noauth is truthy OR auth is falsy
    if (!this.hasAuthToken() || requestConfig.noauth) {
      headers.Authorization = this.generateBasicAuthHeader();
    }

    return headers;
  }

  /**
   * Attach interceptors to requests/responses to do PRE/POST processing, such
   * as attaching client headers and massaging messages
   *
   * @access private
   * @return {void}
   */
  setupRequestInterceptors() {
    const defaults = this.defaultHeaders.bind(this);
    axios.interceptors.request.use((config) =&gt; {
      const headers = (config.headers) ?
            merge(config.headers, defaults(config)) :
            defaults(config);

      config.headers = headers; // eslint-disable-line
      return config;
    }, (error) =&gt; {
      // Do something with request error
      if (__LOG__) {
        console.error(&apos;REQUEST_ERROR&apos;, error); // eslint-disable-line
      }
      return Promise.reject(error);
    });
  }

  /**
   * Ensure the api_url is prepended to all requests
   * @param {String} url
   * @return {String}
   */
  assembleUrl(url) {
    return urlJoin(this.config.get(constants.API_URL), url);
  }

  /**
   * GET
   * @param {String} url
   * @param {Object} [opts] - optional configuration for request
   * @return {Promise}
   */
  get(url, opts = {}) {
    return axios.get(this.assembleUrl(url), opts);
  }

  /**
   * POST
   * @param {String} url
   * @param {Object} data - payload sent to services
   * @param {Object} [opts] - optional configuration for request
   * @return {Promise}
   */
  post(url, data, opts = {}) {
    return axios.post(this.assembleUrl(url), data, opts);
  }

  /**
   * PUT
   * @param {String} url
   * @param {Object} data - payload sent to services
   * @param {Object} [opts] - optional configuration for request
   * @return {Promise}
   */
  put(url, data, opts = {}) {
    return axios.put(this.assembleUrl(url), data, opts);
  }

  /**
   * PATCH
   * @param {String} url
   * @param {Object} data - payload sent to services
   * @param {Object} [opts] - optional configuration for request
   * @return {Promise}
   */
  patch(url, data, opts = {}) {
    return axios.patch(this.assembleUrl(url), data, opts);
  }

  /**
   * DELETE
   * @param {String} url
   * @param {Object} [opts] - optional configuration for request
   * @return {Promise}
   */
  delete(url, opts = {}) {
    return axios.delete(this.assembleUrl(url), opts);
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.5)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
