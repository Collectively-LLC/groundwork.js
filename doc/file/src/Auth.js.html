<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/Auth.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/thegroundwork/groundwork.js.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Auth.js~Auth.html">Auth</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Dictionary.js~Dictionary.html">Dictionary</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Donation.js~Donation.html">Donation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Event.js~Event.html">Event</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/EventCategory.js~EventCategory.html">EventCategory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/EventInvitation.js~EventInvitation.html">EventInvitation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/EventMessage.js~EventMessage.html">EventMessage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/EventTicket.js~EventTicket.html">EventTicket</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Groundwork.js~Groundwork.html">Groundwork</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Http.js~Http.html">Http</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Payment.js~Payment.html">Payment</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Profile.js~Profile.html">Profile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Quickcard.js~Quickcard.html">Quickcard</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/SchemaUtils.js~SchemaUtils.html">SchemaUtils</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Subscription.js~Subscription.html">Subscription</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Supporter.js~Supporter.html">Supporter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-deprecate">deprecate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-epoch">epoch</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-has">has</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isApiVersion">isApiVersion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isEmpty">isEmpty</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-max">max</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mixin">mixin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-normalizeUrl">normalizeUrl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-only">only</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-urlJoin">urlJoin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-validEmail">validEmail</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ENDPOINT_CATEGORY">ENDPOINT_CATEGORY</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ENDPOINT_EVENT">ENDPOINT_EVENT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ENDPOINT_HOST_UNSUBSCRIBE">ENDPOINT_HOST_UNSUBSCRIBE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ENDPOINT_INVITATION">ENDPOINT_INVITATION</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ENDPOINT_MESSAGE">ENDPOINT_MESSAGE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ENDPOINT_TICKET">ENDPOINT_TICKET</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-NAMESPACE">NAMESPACE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-API_URL">API_URL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-API_VERSION">API_VERSION</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AUTH_ACCESS_TOKEN">AUTH_ACCESS_TOKEN</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AUTH_GWID">AUTH_GWID</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AUTH_TOKEN_TYPE">AUTH_TOKEN_TYPE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CONFIG_AUTH">CONFIG_AUTH</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DEFAULT_API_URL">DEFAULT_API_URL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-FACEBOOK_APP_ID">FACEBOOK_APP_ID</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-OAUTH_CLIENT_ID">OAUTH_CLIENT_ID</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RE_API_VERSION">RE_API_VERSION</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/Auth.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import * as constants from &apos;./constants&apos;;
import Dictionary from &apos;./Dictionary&apos;;
import Http from &apos;./Http&apos;;
import merge from &apos;lodash-es/merge&apos;;
import { urlJoin } from &apos;./utils&apos;;

/**
 * API Endpoints
 */
const NAMESPACE = &apos;oauth&apos;;
const ENDPOINT_TOKEN = &apos;token&apos;;

/**
 * Manage oauth and user tokens for the client. Once a successful auth token has
 * been fetched it is stored in `this.config` for use in authenticated
 * requests to the API.
 */
export default class Auth {
  /**
   * Constructor
   * @param {Dictionary} [config] - client configuration
   * @param {Http} http - required
   */
  constructor(config, http) {
    /** @type {Dictionary} */
    this.config = (config &amp;&amp; config instanceof Dictionary) ?
      config : new Dictionary();

    // Resource must have an Http instance
    if (!http || http instanceof Http === false) {
      throw new Error(&apos;Auth requires Http&apos;);
    }

    /** @type {Http} */
    this.http = http;
  }

  /**
   * If a response contains data, drop it into the user key in config
   *
   * @access private
   * @param {Object} response
   * @return {Object}
   */
  storeAuthResponse(response) {
    if (response &amp;&amp; response.status === 200) {
      this.auth = merge({}, this.auth, response.data);
    }
    return response;
  }

  /**
   * Make a POST to the token endpoint and pass the result to
   * storeAuthResponse for handling. The Promise is then returned to the
   * original caller for further chaining.
   *
   * @access private
   * @param {Object} params sent to the endpoint
   * @return {Promise}
   */
  requestToken(data) {
    const url = urlJoin(NAMESPACE, ENDPOINT_TOKEN);
    return this.http.post(url, data).then(this.storeAuthResponse.bind(this));
  }

  /**
   * Wipe out auth settings in config, which will prevent authenticated requests
   * until a new one is fetchd
   *
   * @return {Object}
   */
  destroyToken() {
    this.config.del(constants.CONFIG_AUTH);
    return this.config.set(constants.CONFIG_AUTH, {});
  }

  /**
   * Use email / password to fetch Rex token
   *
   * @param {String} email
   * @param {String} password
   * @return {Promise}
   */
  fetchUsingPassword(email = &apos;&apos;, password = &apos;&apos;) {
    return this.requestToken({
      email,
      password,
      grant_type: &apos;password&apos;
    });
  }

  /**
   * Use Facebook to fetch Rex token
   *
   * @param {String} accessToken
   * @return {Promise}
   */
  fetchUsingFacebook(accessToken = &apos;&apos;) {
    return this.requestToken({
      access_token: accessToken,
      grant_type: &apos;facebook&apos;
    });
  }

  /**
   * Use Google to fetch Rex token
   *
   * @param {String} accessToken
   * @return {Promise}
   */
  fetchUsingGoogle(accessToken = &apos;&apos;) {
    return this.requestToken({
      access_token: accessToken,
      grant_type: &apos;google&apos;
    });
  }

  /**
   * Convenience method to get the Facebook APP Id registered with the client
   *
   * @return {String}
   */
  get facebookAppId() {
    return this.config.get(constants.FACEBOOK_APP_ID);
  }

  /**
   * Return the entire authentication object
   *
   * @return {Object}
   */
  get auth() {
    return this.config.get(constants.CONFIG_AUTH);
  }

  /**
   * Return the authorization token
   *
   * @return {String}
   */
  get token() {
    return this.auth[constants.AUTH_ACCESS_TOKEN];
  }

  /**
   * Return the authorization token
   *
   * @return {String}
   */
  get tokenType() {
    return this.auth[constants.AUTH_TOKEN_TYPE];
  }

  /**
   * Return the gwid
   *
   * @return {String}
   */
  get gwid() {
    return this.auth[constants.AUTH_GWID];
  }

  /**
   * Return a string for use in an Authorization header: &quot;{tokenType} {token}&quot;
   *
   * @return {String}
   */
  get authorizationHeader() {
    return `${ this.tokenType } ${ this.token }`;
  }

  /**
   * Safely merge a key/val into the auth config object, used in setters
   *
   * @access private
   * @param {String} key - key name
   * @param {&lt;any&gt;} val - value to store, usually a string
   * @return {undefined|Object}
   */
  insertAuthKey(key, val) {
    const auth = merge({}, this.auth);
    if (!key || !val) { return undefined; }
    auth[key] = val;
    this.auth = auth;
    return this.auth;
  }

  /**
   * Set auth config object
   *
   * @param {Object} obj - obj to set
   * @return {Object}
   */
  set auth(obj) {
    this.config.set(constants.CONFIG_AUTH, merge({}, obj));
    return this.auth;
  }

  /**
   * Set token config object
   *
   * @type {String}
   */
  set token(token) {
    this.insertAuthKey(constants.AUTH_ACCESS_TOKEN, token);
  }

  /**
   * Set gwid config object
   *
   * @type {String}
   */
  set gwid(gwid) {
    this.insertAuthKey(constants.AUTH_GWID, gwid);
  }

  /**
   * Set tokenType config object
   *
   * @type {String}
   */
  set tokenType(type) {
    this.insertAuthKey(constants.AUTH_TOKEN_TYPE, type);
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.5)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
